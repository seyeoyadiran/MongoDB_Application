<!-- <div class="admin-title">
    <h2>Dashboard</h2>
    <a href="/add-post" class="button">+ Add New</a>
</div> -->

<div class="admin-title" style="display:flex; justify-content: space-between; align-items:center; margin-bottom:30px;">
    <h2 style="color:#fff; font-weight:600; letter-spacing:0.5px;">Dashboard</h2>
    <a href="/add-post" style="
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px) saturate(150%);
        -webkit-backdrop-filter: blur(10px) saturate(150%);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 12px;
        padding: 0.5rem 1.2rem;
        color: #fff;
        font-weight:500;
        text-decoration:none;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    "
    onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';"
    onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
        + Add New
    </a>
</div>


<!-- ðŸ”¹ Horizontal Tab Navigation -->
<div style="display:flex; justify-content:center; margin-bottom:30px; gap:20px; border-bottom: 2px solid rgba(255,255,255,0.2); flex-wrap:wrap;">
  <div id="analyticsTabBtn" onclick="showTab('analytics')" style="
      padding:10px 25px;
      cursor:pointer;
      font-weight:500;
      color:#fff;
      transition: all 0.3s ease;
      text-align:center;
      border-bottom: 3px solid #8e44ad;
  "
  onmouseover="this.style.color='#8e44ad';" 
  onmouseout="if(currentTab!=='analytics'){this.style.color='#fff';}">
    Analytics
  </div>

  <div id="postsTabBtn" onclick="showTab('posts')" style="
      padding:10px 25px;
      cursor:pointer;
      font-weight:500;
      color: #ccc;
      transition: all 0.3s ease;
      text-align:center;
      border-bottom: 3px solid transparent;
  "
  onmouseover="this.style.color='#8e44ad';" 
  onmouseout="if(currentTab!=='posts'){this.style.color='#ccc';}">
    My Posts
  </div>
</div>

<!-- ðŸ”¹ Analytics Section -->
<div id="analyticsTab" style="display:block;">
  <div class="analytics" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px,1fr)); gap:20px; margin-bottom:30px;">
    <div class="card" style="background:#1c1c1c; padding:20px; border-radius:12px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.4);">
      <h3 style="margin:0; font-size:1rem; color:#ccc;">Total Posts</h3>
      <p id="totalPosts" style="margin:8px 0 0; font-size:1.5rem; font-weight:600; color:#8e44ad;">0</p>
    </div>
    <div class="card" style="background:#1c1c1c; padding:20px; border-radius:12px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.4);">
      <h3 style="margin:0; font-size:1rem; color:#ccc;">Total Views</h3>
      <p id="totalViews" style="margin:8px 0 0; font-size:1.5rem; font-weight:600; color:#8e44ad;">0</p>
    </div>
    <div class="card" style="background:#1c1c1c; padding:20px; border-radius:12px; text-align:center; box-shadow:0 4px 12px rgba(0,0,0,0.4);">
      <h3 style="margin:0; font-size:1rem; color:#ccc;">Site Visits</h3>
      <p id="siteVisits" style="margin:8px 0 0; font-size:1.5rem; font-weight:600; color:#8e44ad;">0</p>
    </div>
  </div>

  <div class="chart-container" style="margin-top:30px; background:#1c1c1c; padding:20px; border-radius:10px;">
    <h3 style="margin-bottom:15px;">Site Visits (Last 7 Days)</h3>
    <canvas id="visitsChart" height="100"></canvas>
  </div>
</div>

<!-- ðŸ”¹ Posts Section -->
<div id="postsTab" style="display:none;">
  <!-- Title & Sort -->
  <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
    <h3 style="color:#fff; font-size:1.4rem; font-weight:600; margin:0; letter-spacing:0.5px;">My Posts</h3>
    
    <div style="position:relative;">
      <select id="sortPosts" style="
          appearance:none;
          -webkit-appearance:none;
          background: rgba(255,255,255,0.08);
          color:#fff;
          border:none;
          border-radius:10px;
          padding:0.3rem 1.8rem 0.3rem 0.6rem;
          cursor:pointer;
          font-weight:500;
          font-size:0.9rem;
          transition: all 0.3s ease;
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          min-width: 140px;
          text-align:center;
      " 
      onmouseover="this.style.background='rgba(255,255,255,0.15)';" 
      onmouseout="this.style.background='rgba(255,255,255,0.08)';">
        <option value="recent">Most Recent</option>
        <option value="oldest">Oldest</option>
        <option value="views">Most Viewed</option>
      </select>
      <!-- Dropdown arrow -->
      <span style="
        
          position:absolute;
          right:0.6rem;
          top:35%;
          transform:translateY(-50%);
          pointer-events:none;
          color:#fff;
          font-size:0.8rem;
      ">â–¼</span>
    </div>
  </div>

  <!-- Posts List -->
  <ul id="postsList" class="admin-posts" style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:1rem;">
    <% data.forEach(post => { %>
        <li data-date="<%= post.createdAt %>" data-views="<%= post.views || 0 %>" style="
            background: rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(12px) saturate(150%);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        " 
        onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 36px rgba(0,0,0,0.25)';" 
        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 32px rgba(0,0,0,0.15)';">
            <a href="/post/<%= post._id %>" style="text-decoration:none; color:#fff; font-weight:500; font-size:1rem;">
                <%= post.title %> &nearr;
            </a>
            <div class="admin-post-controls" style="display:flex; gap:0.5rem;">
                <a href="/edit-post/<%= post._id %>" class="btn" style="
                    background: rgba(255,255,255,0.15); 
                    color:#fff; 
                    border:none; 
                    padding:0.4rem 0.8rem; 
                    border-radius:8px; 
                    cursor:pointer; 
                    font-size:0.9rem;
                    transition: background 0.3s ease;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)';" 
                    onmouseout="this.style.background='rgba(255,255,255,0.15)';">
                    Edit
                </a>
                
                <form action="/delete-post/<%= post._id %>?_method=DELETE" method="POST">
                    <input type="submit" value="Delete" class="btn" style="
                        background: rgba(255,255,255,0.15); 
                        color:#fff; 
                        border:none; 
                        padding:0.4rem 0.8rem; 
                        border-radius:8px; 
                        cursor:pointer; 
                        font-size:0.9rem;
                        transition: background 0.3s ease;"
                        onmouseover="this.style.background='rgba(255,255,255,0.3)';" 
                        onmouseout="this.style.background='rgba(255,255,255,0.15)';">
                    </input>
                </form>
            </div>
        </li>
    <% }) %>
  </ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let visitsChart;
let currentTab = 'analytics';

function showTab(tab) {
    currentTab = tab;
    document.getElementById('analyticsTab').style.display = tab === 'analytics' ? 'block' : 'none';
    document.getElementById('postsTab').style.display = tab === 'posts' ? 'block' : 'none';

    const analyticsBtn = document.getElementById('analyticsTabBtn');
    const postsBtn = document.getElementById('postsTabBtn');

    if(tab === 'analytics'){
        analyticsBtn.style.color = '#fff';
        analyticsBtn.style.borderBottom = '3px solid #8e44ad';
        postsBtn.style.color = '#ccc';
        postsBtn.style.borderBottom = '3px solid transparent';
    } else {
        postsBtn.style.color = '#fff';
        postsBtn.style.borderBottom = '3px solid #8e44ad';
        analyticsBtn.style.color = '#ccc';
        analyticsBtn.style.borderBottom = '3px solid transparent';
    }
}

async function fetchAnalytics() {
    try {
      const res = await fetch("/admin/api/analytics");
      const data = await res.json();

      document.getElementById("totalPosts").innerText = data.totalPosts;
      document.getElementById("totalViews").innerText = data.totalViews;
      document.getElementById("siteVisits").innerText = data.siteVisits;

      const labels = data.visitsByDay.map(v => v._id);
      const counts = data.visitsByDay.map(v => v.count);

      if (!visitsChart) {
        const ctx = document.getElementById("visitsChart").getContext("2d");
        visitsChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [{
              label: "Site Visits",
              data: counts,
              borderColor: "#4e9af1",
              backgroundColor: "rgba(78,154,241,0.2)",
              tension: 0.3,
              fill: true,
              borderWidth: 2,
              pointRadius: 4,
              pointBackgroundColor: "#4e9af1"
            }]
          },
          options: {
            plugins: { legend: { labels: { color: "#fff" } } },
            scales: {
              x: { ticks: { color: "#fff" }, grid: { color: "#444" } },
              y: { ticks: { color: "#fff" }, grid: { color: "#444" } }
            }
          }
        });
      } else {
        visitsChart.data.labels = labels;
        visitsChart.data.datasets[0].data = counts;
        visitsChart.update();
      }
    } catch (err) {
      console.error("Failed to load analytics:", err);
    }
}

// Initial load + refresh every 15 seconds
fetchAnalytics();
setInterval(fetchAnalytics, 15000);

// Sorting functionality
const sortSelect = document.getElementById('sortPosts');
const postsList = document.getElementById('postsList');

sortSelect.addEventListener('change', function() {
  const posts = Array.from(postsList.querySelectorAll('li'));
  const sortBy = this.value;

  posts.sort((a,b) => {
    if(sortBy === 'recent') {
      return new Date(b.dataset.date) - new Date(a.dataset.date);
    } else if(sortBy === 'oldest') {
      return new Date(a.dataset.date) - new Date(b.dataset.date);
    } else if(sortBy === 'views') {
      return b.dataset.views - a.dataset.views;
    }
  });

  posts.forEach(post => postsList.appendChild(post));
});
</script>
